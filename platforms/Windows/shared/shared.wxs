<Wix xmlns="http://wixtoolset.org/schemas/v4/wxs" xmlns:util="http://wixtoolset.org/schemas/v4/wxs/util">
  <Fragment>
    <StandardDirectory Id="LocalAppDataFolder">
      <Directory Name="Programs">
        <Directory Id="INSTALLROOT" Name="Swift" />
      </Directory>
    </StandardDirectory>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLROOT">
        <Directory Name="Toolchains">
          <Directory Id="ToolchainsVersioned" Name="$(ProductVersion)+Asserts">
            <Directory Id="_usr" Name="usr">
              <Directory Id="_usr_bin" Name="bin" />
              <Directory Id="_usr_include" Name="include" />
              <Directory Id="_usr_lib" Name="lib">
                <Directory Id="_usr_lib_clang" Name="clang" />
                <Directory Id="_usr_lib_swift" Name="swift" />
              </Directory>
            </Directory>
          </Directory>
        </Directory>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLROOT">
      <Directory Name="Runtimes">
        <Directory Id="RuntimesVersioned" Name="$(ProductVersion)">
          <Directory Name="usr">
            <Directory Id="runtimes_usr_bin" Name="bin" />
          </Directory>
        </Directory>
      </Directory>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLROOT">
      <Directory Name="Platforms">
        <Directory Id="Platforms" Name="$(ProductVersion)" />
      </Directory>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLROOT">
      <Directory Name="Tools">
        <Directory Id="Tools" Name="$(ProductVersion)" />
      </Directory>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <DirectoryRef Id="INSTALLROOT">
      <Directory Name="Redistributables">
        <Directory Id="RedistVersion" Name="$(ProductVersion)" />
      </Directory>
    </DirectoryRef>
  </Fragment>

  <Fragment>
    <Component Id="SystemToolsEnvironmentVariables" Guid="5BA7803B-1EA5-45D3-8FD7-C75518C2C099" Directory="Tools">
      <Environment Id="Path" Action="set" Name="Path" Part="last" Permanent="no" System="no" Value="[Tools]" />
    </Component>
  </Fragment>

  <Fragment>
    <ComponentGroup Id="VersionedDirectoryCleanup">
      <Component Id="VersionedDirectoryCleanup" Guid="0BCA6DA7-A217-4DB7-9868-37CAC22FFDD9" Directory="INSTALLROOT">
        <util:RemoveFolderEx Property="ToolchainsVersioned" />
        <util:RemoveFolderEx Property="Platforms" />
        <util:RemoveFolderEx Property="Tools" />
        <util:RemoveFolderEx Property="RuntimesVersioned" />
        <util:RemoveFolderEx Property="Redistributables" />
      </Component>
    </ComponentGroup>
  </Fragment>

  <!--
  To support side-by-side installation for each minor release (the latest point release of each minor release),
  we need to use "old-school" `Upgrade`/`UpgradeVersion` authoring to get the upgrade version ranges, which
  also requires manually scheduling `RemoveExistingProducts`. To avoid duplication, the upgrade logic is
  authored here and referenced from the `Package` element of each package.
  -->
  <Fragment>
    <FeatureGroup Id="SideBySideUpgradeStrategy">
      <FeatureGroupRef Id="SideBySideUpgradeStrategyShared" />
    </FeatureGroup>

    <Upgrade Id="!(wix.SideBySidePackageUpgradeCode)">
      <UpgradeVersion Minimum="$(MajorMinorProductVersion).65535" IncludeMinimum="no" OnlyDetect="yes" Property="NEWERVERSIONDETECTED" />
      <UpgradeVersion Minimum="$(MajorMinorProductVersion).0" IncludeMinimum="yes" Maximum="$(ProductVersion)" IncludeMaximum="yes" Property="OLDERVERSIONBEINGUPGRADED" />
    </Upgrade>
  </Fragment>

  <Fragment>
    <FeatureGroup Id="SideBySideUpgradeStrategyShared" />

    <Launch Message="!(loc.DowngradeError)" Condition="NOT NEWERVERSIONDETECTED" />

    <InstallExecuteSequence>
      <RemoveExistingProducts After="InstallValidate" />
    </InstallExecuteSequence>
  </Fragment>
</Wix>
